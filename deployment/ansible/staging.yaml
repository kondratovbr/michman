-   hosts: staging
    become: true
    tasks:

    -   name: Update staging Docker Compose config
        synchronize:
            src: ../../deployment/
            dest: /home/michman/michman
            archive: false
            recursive: true
            checksum: true
            delete: true

    -   name: Chown Docker Compose config files
        file:
            path: /home/michman/michman
            state: directory
            recurse: yes
            owner: michman
            group: michman

    -   name: Login to Docker Hub
        when: (docker_username is defined) and (docker_password is defined)
        docker_login:
            username: "{{ docker_username }}"
            password: "{{ docker_password }}"

    -   name: Stop services that depend on public assets
        docker_compose:
            project_src: /home/michman/michman
            files: docker-compose.stage.yaml
            project_name: michman-stage
            services:
                - app
                - queue
                - scheduler
                - nginx
            stopped: true

    -   name: Remove public files directory
        file:
            path: /home/michman/michman/public
            state: absent

    -   name: Recreate an empty public files directory
        file:
            path: /home/michman/michman/public
            state: directory
            owner: michman
            group: michman

#  TODO: Add a step with docker-compose yaml files validation using "docker-compose config"

#     -   name: Deploy Docker Compose project and restart services
#         docker_compose:
#             project_src: /home/michman/michman
#             files: docker-compose.stage.yaml
#             project_name: michman-stage
#             build: false
#             pull: true
#             recreate: always

#     -   name: Remove the volume with public assets
#         docker_volume:
#             name: volume_one
#             state: absent

    -   name: Deploy Docker Compose project and restart services
        docker_compose:
            project_src: /home/michman/michman
            files: docker-compose.stage.yaml
            project_name: michman-stage
            build: false
            pull: true
            recreate: always
            remove_orphans: true
        register: output

    -   name: Print output
        debug: var=output
